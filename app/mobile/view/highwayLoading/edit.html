<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta name="Keywords" content="">
<meta name="Description" content="">
<title>日照兰花业财一体化系统</title>
<link rel="stylesheet" type="text/css" href="__STATIC__/mobile/css/default.css?v={:time()}" media="all">
<link rel="stylesheet" type="text/css" href="__STATIC__/mobile/css/swiper.min.css?v={:time()}" media="all">
<link rel="stylesheet" type="text/css" href="__STATIC__/mobile/css/layer.css?v={:time()}" >
<link rel="stylesheet" type="text/css" href="__STATIC__/plugs/layui-v2.5.6/css/layui.css?v={:time()}" >
<script type="text/javascript" src="__STATIC__/mobile/js/rem.js?v={:time()}"></script>
<script type="text/javascript" src="__STATIC__/plugs/jquery-3.4.1/jquery-3.4.1.min.js?v={:time()}"></script>
<script type="text/javascript" src="__STATIC__/mobile/js/layer.js?v={:time()}"></script>
<script type="text/javascript" src="__STATIC__/mobile/js/swiper.min.js?v={:time()}"></script>
<script type="text/javascript" src="__STATIC__/plugs/layui-v2.5.6/layui.js?v={:time()}"></script>
<script type="text/javascript" src="__STATIC__/mobile/js/Mdate/iScroll.js?v={:time()}"></script>
<script type="text/javascript" src="__STATIC__/mobile/js/Mdate/Mdate.js?v={:time()}"></script>
<body>
<style>
.layui-form-select dl {
	max-height: 200px;
}
#biaoform{font-size: 0.24rem;padding: 0.4rem;width: 6rem;}
#biaoform .layui-input{width: 100%;margin-bottom: 0.2rem;}
.layui-layer-btn .layui-layer-btn0{font-size: 0.24rem;width: 50%;margin: 0;height: 48px;line-height: 48px;}
.layui-layer-btn .layui-layer-btn1{font-size: 0.24rem;width: 50%;margin: 0;height: 48px;line-height: 48px;background:#f1f1f1;}
.layui-layer-btn{text-align: center;padding: 0;}
.layui-layer-btn a{border: none;}
.layui-layer-btn{background-color: #F8F8F8;padding-top: 0!important;}
.layui-form-select dl{width: 100%;}
.layui-form-select .layui-edge{z-index: 3;}
</style>
	<div class="head fc">
		<a href="javascript:window.history.go(-1);" class="back"><i class="layui-icon">&#xe603;</i></a>
		{$title}
		<a class="add" href="/Highwayloading/">入库管理</a>
	</div>
	<form id="app-form" class="layui-form layuimini-form">
		<div class="form layui-form-pane">
			<div class="tit">装车信息</div>
			<input type="hidden" name="id" value="{$row.id}">
			<div class="layui-form-item">
	            <label class="layui-form-label">提货单号</label>
	            <div class="layui-input-block">
	                <input type="text" name="plan" class="layui-input"  value="{$row.plan}">
	            </div>
	        </div>
	        <div class="layui-form-item">
	            <label class="layui-form-label">发运类型</label>
	            <div class="layui-input-block">
	            	<select name="trans_type" lay-filter="cYsType_select">
	            		<option value="">请选择发运类型</option>
	            		<option {if $row.trans_type==1} selected="" {/if} value="1">直发</option>
	            		<option {if $row.trans_type==2} selected="" {/if} value="2">转存</option>
	            		<option {if $row.trans_type==3} selected="" {/if} value="3">仓库现货发运</option>
	            	</select>
	            </div>
	        </div>
	        <div class="layui-form-item" id="ku" {if $row.trans_type==2} style="display: block;" {else} style="display: none;" {/if}>
	            <label class="layui-form-label">入库仓库</label>
	            <div class="layui-input-block">
	            	<select name="store">
	            		<option value="">请选择</option>
	            		{foreach $stocks as $k=>$v}
	            		<option {if $row.store==$v.id} selected="" {/if} value="{$v.id}">{$v.name}</option>
	            		{/foreach}
	            	</select>
	            </div>
	        </div>
			<div class="layui-form-item">
	            <label class="layui-form-label">装车日期</label>
	            <div class="layui-input-block">
	                <input type="text" name="ScDate" autocomplete="off" class="layui-input" data-year="{:date('Y',$row.loaddate)}" data-month="{:date('m',$row.loaddate)}" data-day="{:date('d',$row.loaddate)}" id="dateSelectorOne" placeholder="" value="{:date('Y-m-d',$row.loaddate)}">
	            </div>
	        </div>
	        <div class="layui-form-item">
	            <label class="layui-form-label">起运地</label>
	            <div class="layui-input-block">
	            	<select name="start_station" lay-filter="ScStarName_select" autocomplete="off" lay-search="">
	            		<option value="">直接选择或搜索选择</option>
	            		{foreach $highwaysite as $v}
          				<option {if $row.start_station==$v.id} selected="" {/if} value="{$v.id}">{$v.name}</option>
          				{/foreach}
	            	</select>
	            </div>
	        </div>
	        <div class="layui-form-item">
	            <label class="layui-form-label">运达地</label>
	            <div class="layui-input-block">
	            	<select name="end_station" lay-filter="ScStopName_select" autocomplete="off" lay-search="">
	            		<option value="">直接选择或搜索选择</option>
	            		{foreach $highwaysite as $v}
          				<option {if $row.end_station==$v.id} selected="" {/if} value="{$v.id}">{$v.name}</option>
          				{/foreach}
	            	</select>
	            </div>
	        </div>
	        <div class="layui-form-item">
	            <label class="layui-form-label">承运人</label>
	            <div class="layui-input-block">
	                <input type="text" name="cusname" class="layui-input" placeholder="请填写承运人" value="{$row.cusname}">
	            </div>
	        </div>
	        <div class="layui-form-item">
	            <label class="layui-form-label">品种</label>
	            <div class="layui-input-block">
	            	<select name="coaltype" lay-filter="ScCoalType_select" autocomplete="off" lay-search="">
	            		<option value="">直接选择或搜索选择</option>
	            		{foreach $coaltype as $v}
          				<option {if $row.coaltype==$v.id} selected="" {/if} value="{$v.id}">{$v.name}</option>
          				{/foreach}
	            	</select>
	            </div>
	        </div>
	        <div class="layui-form-item">
	            <label class="layui-form-label required">矿点</label>
	            <div class="layui-input-block">
	                <select name="mini">
	            		<option value="">请选择</option>
	            		{foreach $colliery as $k=>$v}
	            		<option {if $row.mini==$v.id} selected="" {/if} value="{$v.id}">{$v.name}</option>
	            		{/foreach}
	            	</select>
	            </div>
	        </div>
	        <div class="layui-form-item">
	            <label class="layui-form-label required">物流方式</label>
	            <div class="layui-input-block">
	                <select name="road">
	            		<option value="">请选择</option>
	            		{foreach $ship as $k=>$v}
	            		<option {if $row.road==$v.id} selected="" {/if} value="{$v.id}">{$v.name}</option>
	            		{/foreach}
	            	</select>
	            </div>
	        </div>
		</div>
		<div class="form layui-form-pane">
			<div class="tit">装车明细</div>
			<div class="layui-form-item text-center">
				<table class="layui-table" style="width:100%;text-align: center;margin: 0;table-layout: fixed;">
				    <thead>
				    	<tr>
				        	<th width="10%" style="text-align: center;">序号</th>
				        	<th width="30%" style="text-align: center;">车牌号</th>
				        	<th width="20%" style="text-align: center;">矿发吨数</th>
				        	<th width="20%" style="text-align: center;">入库数</th>
				        	<th width="20%" style="text-align: center;">操作</th>
				      	</tr> 
				    </thead>
		    		<tbody id="td">
		    			{foreach $saleCoalDetail as $k=>$v}
		    				<tr>
		    					<td>{$k+1}<input type="hidden" name="sale[0][sc_id]" value="{$v.sc_id}"></td>
		    					<td><input class="layui-input layui-table-edit" name="sale[{$k}][plan]" value="{$v.plan}"></td>
		    					<td><input class="layui-input layui-table-edit" oninput="count1(this)" name="sale[{$k}][sweight]" value="{:floatval($v.sweight)}"></td>
		    					<td><input class="layui-input layui-table-edit" oninput="count1(this)" name="sale[{$k}][fweight]" value="{:floatval($v.fweight)}"></td>
		    					<td onclick="del(this)"><i class="layui-icon">&#xe640;</i></td>
		    				</tr>
		    			{/foreach}
		    				<tr>	
		    					<td>{$cou+1}<input type="hidden" name="sale[{$cou}][sc_id]" value=""></td>
		    					<td><input class="layui-input layui-table-edit" name="sale[{$cou}][plan]" value=""></td>
		    					<td><input class="layui-input layui-table-edit" name="sale[{$cou}][sweight]" value=""></td>
		    					<td><input class="layui-input layui-table-edit" name="sale[{$cou}][fweight]" value=""></td>
		    					<td onclick="del(this)"><i class="layui-icon">&#xe640;</i></td>
		    				</tr>
		    			<tr>
		    				<td><span style="color: red">合计</span></td>
		    				<td></td>
		    				<td><span style="color: red" id="TotalSou1"></span></td>
		    				<td><span style="color: red" id="TotalSou2"></span></td>
		    				<td></td>
		    			</tr>
		      		</tbody>
		      	</table>
		    </div>
		    <div class="layui-form-item">
				<div class="tip">请上传公路货运单货运单，可多张上传。</div>
				<div class="up">
					<div class="layui-upload-drag" id="office">
						<i class="layui-icon"></i>
						<p>点击上传</p>
					</div>
					<span style="height: 120px;width: 40px;position: absolute;left: 120px;top: 0;display: flex;align-items: center;justify-content: center;font-size: 0.28em;">或</span>
					<div class="layui-upload-drag" id="biao" style="left: 160px;">
						<i class="layui-icon">&#xe629;</i>
						<p>表单添加</p>
					</div>
				</div>
			</div>
			<div class="layui-form-item text-center">
	            <button type="submit" class="layui-btn" lay-submit lay-filter="demo1">确认</button>
	        </div>
	    </div>
	</form>
	<div class="biaoform" id="biaoform" style="display: none;">
		<input type="text" name="ScdDep" class="layui-input" autocomplete="off" placeholder="请填写车牌号" value="">
		<input type="text" name="ScdWeight" class="layui-input" autocomplete="off" placeholder="请填写矿发吨数" value="">
		<input type="text" name="ScdWeight2" class="layui-input" autocomplete="off" placeholder="请填写净重" value="" style="margin-bottom: 0;">
	</div>
	<script>
	totalSouFund();
	function count1(obj){
		$(obj).val($(obj).val());
		$("#td").find("tr:not(:last) input").keyup(function(){
			totalSouFund();
		})
	}
	function totalSouFund() {
		totalSou1 = 0;
		totalSou2 = 0;
		$("#td tr:not(:last)").each(function () {
			$(this).find("td:eq(2) input").each(function () {
				totalSou1 += getNumValue($(this)) ;
				$("#TotalSou1").html(Number(totalSou1.toFixed(4)));
			});
			$(this).find("td:eq(3) input").each(function () {
				totalSou2 += getNumValue($(this)) ;
				$("#TotalSou2").html(Number(totalSou2.toFixed(4)));
			});
		})
	}
	function getNumValue(controlid) {
		var num = controlid.val();
		if (validateInput(num)) {
			num = parseFloat(num);
		}else {
			controlid.val("");
			num = 0;
		}
		return num;
	}
	function validateInput(inputstr) {
		flag = false;
		if (inputstr != "") {
			if (isNaN(inputstr)) {
		  		flag = false; //如果输入字符不是数字
			}else{
				if (parseFloat(inputstr) < 0){
					flag = false;
				}else{
		  			flag = true;
				}
		  	}
		}
		return flag;
	}
	new Mdate("dateSelectorOne",{
		beginYear: "2002",
	    beginMonth: "10",
	    beginDay: "24",
		endYear: "2050",
	    endMonth: "12",
	    endDay: "31",
		format: "-"
	});
	function del(obj){
		console.info($(obj).parent().find("input[name='ScdDep']").val());
		console.info($(obj).parent().find("td").eq(1).find("input").val()!='');
		if($(obj).parent().find("td").eq(1).find("input").val()!=''){
			$(obj).parent().remove();
		}
		totalSouFund();
	}
	$("#biao").click(function(){
		layer.open({
		    type: 1,
		    title: false,
		    shadeClose: true,
		    closeBtn: 0,
		    content: $("#biaoform"),
		    btn: ['确定', '不要'],
		    yes: function(index,layero){
		    	var ScdDep = layero.find("input[name='ScdDep']").val()
		    	var ScdWeight = layero.find("input[name='ScdWeight']").val()
		    	var ScdWeight2 = layero.find("input[name='ScdWeight2']").val()
		    	if(!ScdDep){
		    		layer.msg("请填写车牌号！");
		    		return false;
		    	}
		    	if(!ScdWeight2){
		    		layer.msg("请填写净重！");
		    		return false;
		    	}
		    	if(ScdWeight==''){
		    		ScdWeight = 0;
		    	}
		    	var i = $("#td tr").length;
		    	$("#td tr").eq(-2).find("td:eq(1) input").val(ScdDep);
		    	$("#td tr").eq(-2).find("td:eq(2) input").val(ScdWeight);
		    	$("#td tr").eq(-2).find("td:eq(3) input").val(ScdWeight2);
		    	layero.find("input[name='ScdDep']").val('');
		    	layero.find("input[name='ScdWeight']").val('');
		    	layero.find("input[name='ScdWeight2']").val('');
		    	$("#td tr").eq(-2).after('<tr><td>'+i+'<input type="hidden" name="sale['+(i-1)+'][sc_id]" value=""></td>'
    					+'<td><input class="layui-input layui-table-edit" name="sale['+(i-1)+'][plan]" value=""></td>'
    					+'<td><input class="layui-input layui-table-edit" oninput="count1(this)" name="sale['+(i-1)+'][sweight]" value=""></td>'
    					+'<td><input class="layui-input layui-table-edit" oninput="count1(this)" name="sale['+(i-1)+'][fweight]" value=""></td>'
    					+'<td onclick="del(this)"><i class="layui-icon">&#xe640;</i></td></tr>')
    			totalSouFund();
		    	layer.close(index);
	    	}
		})
	})
	layui.use(['form','upload'], function() {
	    var $ = layui.jquery;
	    var upload = layui.upload;
	    var form = layui.form;
	    var tishi;
	    $("select[name='road']").val(1);//铁路
		$("select[name='road']").attr('disabled','disabled');
		layui.form.render();
	    form.on('select(cYsType_select)', function(data) {
            //发运类型，采购入库显示入库仓库
            if (data.value == "2") {
            	$("#ku").show();
            }else {
            	$("#ku select").val("");
            	layui.form.render();
            	$("#ku").hide();
            }
        });
	    upload.render({
	        elem: '#office',
	        url: '/Highwayloading/upload',
	        multiple: true,
	        before: function(obj){
	        	tishi = layer.msg('文档识别中..', {
	        	    icon: 16
	        	    ,shade: 0.3
	        	    ,time: false
	        	});
	        },
	        done: function(res){
	        	layer.close(tishi);
	        	if(res.code==1){
	        		var i = $("#td tr").length;
	        		$("#td tr").eq(-2).find("td:eq(1) input").val(res.data[0].words);
			    	$("#td tr").eq(-2).find("td:eq(3) input").val(res.data[1].words);
	        		if(res.data[2]==undefined){
	        			$("#td tr").eq(-2).find("td:eq(2) input").val(0);
	        		}else{
	        			$("#td tr").eq(-2).find("td:eq(2) input").val(res.data[2].words);
	        		}
	        		$("#td tr").eq(-2).after('<tr><td>'+i+'<input type="hidden" name="sale['+(i-1)+'][ScdID]" value=""></td>'
	    					+'<td><input class="layui-input layui-table-edit" name="sale['+(i-1)+'][ScdDep]" value=""></td>'
	    					+'<td><input class="layui-input layui-table-edit" name="sale['+(i-1)+'][ScdWeight]" value=""></td>'
	    					+'<td><input class="layui-input layui-table-edit" name="sale['+(i-1)+'][ScdWeight2]" value=""></td>'
	    					+'<td onclick="del(this)"><i class="layui-icon">&#xe640;</i></td></tr>')
	    			totalSouFund();
	        	}else{
	        		layer.msg(res.msg);
	        	}
	        	
	        },
	        error: function(res, index, upload){
	        	layer.close(tishi);
	        	layer.msg(res.msg);
	        }
		});
	    
        
        //表单提交
	    form.on('submit(demo1)', function(data){
	    	if(!$("input[name='plan']").val()){
	    		layer.msg("请填写提货单号！");
	    		return false;
	    	}
	    	if(!$("select[name='trans_type']").val()){
	    		layer.msg("请选择发运类型！");
	    		return false;
	    	}
	    	if(!$("select[name='start_station']").val()){
	    		layer.msg("请选择起运地！");
	    		return false;
	    	}
	    	if(!$("select[name='end_station']").val()){
	    		layer.msg("请选择运达地！");
	    		return false;
	    	}
	    	if(!$("input[name='cusname']").val()){
	    		layer.msg("请填写承运人！");
	    		return false;
	    	}
	    	if(!$("select[name='coaltype']").val()){
	    		layer.msg("请选择品种！");
	    		return false;
	    	}
	    	if($("select[name='trans_type']").val()=="2"){
	    		if(!$("select[name='store']").val()){
		    		layer.msg("请选择入库仓库！");
		    		return false;
		    	}
	    	}
	    	$.ajax({
                url:"/Highwayloading/edit/",
                dataType:'json',
                type:'post',
                beforeSend: function(obj){
    	        	tishi = layer.msg('修改中..', {
    	        	    icon: 16
    	        	    ,shade: 0.3
    	        	    ,time: false
    	        	});
    	        },
                data: data.field,
                success:function(t){
                	layer.close(tishi);
                	if(t.code==1){
                		window.location = '/Highwayloading/edit?id='+t.data;
                	}else{
                		layer.msg(t.msg);
                	}
                },
                error: function () {
                    layer.open({content:'网络繁忙,请重试',skin:'msg',time:2});
                }
            })
	        return false;
	    });
	})
	</script>
	{include file="common/bot" /}
</body>
</html>